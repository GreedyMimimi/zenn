---
title: XRPLのEscrowで条件付き送金を実装する：決済確実化ハンズオン
emoji: 🔐
type: tech
topics: [xrpl, blockchain, escrow, payment, javascript]
published: true
---

## はじめに

XRP Ledger（XRPL）には、**Escrow** という強力な機能があります。これは「条件が満たされるまで資金を凍結し、その後自動的に送金する」という仕組みです。

スマートコントラクトなしで、**プロトコルレベルで実装された決済確実化**。これがXRPLの強みです。

### この記事で学べること

- Escrow（エスクロー）の概念と実装方法
- 時間ベースの送金（Time-lock）
- 条件ベースの送金（Conditional Escrow）
- 実装コード例と実際の活用例
- エージェント間の信頼レスな決済

### 前提知識

- JavaScriptの基本知識
- XRPLの基本概念（アカウント、トランザクション）
- xrpl.jsライブラリの基本

## Escrow とは？

Escrowは「第三者が資金を預かり、条件が満たされたら送金する」という仕組みです。

### 実世界での例

```
Alice → 資金を Escrow にロック
         （条件：Bob が署名）
Escrow → Bob が条件を満たしたら、
         資金を Bob に送金
```

### XRPLの Escrow の特徴

| 特徴 | メリット |
|------|---------|
| プロトコル実装 | スマートコントラクトリスク なし |
| 条件は署名 or 時間 | シンプルで検証可能 |
| 自動執行 | オラクル不要 |
| 確実な決済 | 不可逆、リスク最小 |

## 実装例1：時間ベースの Escrow

指定時刻に自動的に送金します。

```javascript
const xrpl = require('xrpl');

async function createTimeLockEscrow() {
  const client = new xrpl.Client('wss://xrplcluster.com');
  await client.connect();

  const tx = {
    Account: 'rN7n7otQDd6FczFgLdlqeaWFzLXQKmyc6u', // Alice
    Destination: 'rLHzPsX6oXkzU9fCKcRbJz9XDkqcyoxvQ7', // Bob
    Amount: xrpl.xrpToDrops('10'),
    TransactionType: 'EscrowCreate',
    FinishAfter: Math.floor(Date.now() / 1000) + 3600, // 1時間後
  };

  const wallet = xrpl.Wallet.fromSeed('sEd7...'); // Alice のシード
  const result = await client.submitAndWait(tx, { wallet });

  console.log('Escrow created:', result);
  await client.disconnect();
}

createTimeLockEscrow();
```

**ポイント：**
- `FinishAfter`: この時刻以降、誰でもEscrowを実行可能
- XRPLが自動実行するわけではなく、誰かが実行トランザクションを送信

## 実装例2：条件付き Escrow

署名によって条件を満たします。

```javascript
const crypto = require('crypto');

// 1. 秘密を生成
const secret = crypto.randomBytes(16);
const fulfillment = crypto.createHash('sha256').update(secret).digest();

// 2. Escrow を作成（fulfillment hash を指定）
const tx = {
  Account: 'rN7n7otQDd6FczFgLdlqeaWFzLXQKmyc6u',
  Destination: 'rLHzPsX6oXkzU9fCKcRbJz9XDkqcyoxvQ7',
  Amount: xrpl.xrpToDrops('10'),
  TransactionType: 'EscrowCreate',
  Condition: fulfillment.toString('hex'),
};

// 3. Bob が秘密を持って Escrow を実行
const finish_tx = {
  Account: 'rLHzPsX6oXkzU9fCKcRbJz9XDkqcyoxvQ7', // Bob
  Owner: 'rN7n7otQDd6FczFgLdlqeaWFzLXQKmyc6u', // Alice
  TransactionType: 'EscrowFinish',
  Fulfillment: secret.toString('hex'),
};
```

**ポイント：**
- `Condition`: 秘密のハッシュ値
- `Fulfillment`: 実際の秘密
- Bob だけが秘密を知っているので、Bob だけがEscrowを実行可能

## エージェント間の信頼レスな決済

これがXRPLの強力さです。

```
Agent A → 10 XRP を Escrow ロック
          （条件：Agent B の署名）
Escrow  → Agent B がサービス提供 → 署名して実行
          → 自動的に 10 XRP が Agent B に送金
```

**ポイント：**
- 仲介者不要
- スマートコントラクト不要
- 署名があれば確実に送金される
- 署名がなければ資金は戻る（CancelAfter指定時）

## 実装上の注意

- **Escrow実行は誰でも可能** — CancelAfter を設定して、期限を超えたら返金
- **署名による条件は64バイト以下** — 大きなデータは不可
- **費用（ドロップ）** — Escrow作成・実行に手数料がかかる

## まとめ

Escrowは、**スマートコントラクトなしで実装された決済確実化**。

エージェント、機関、個人が、信頼レスに価値交換できるXRPLの強みです。

次は、Pathfinding（クロスカレンシー決済）や、Sidechain上でのEscrow活用を試してみてください。🦞

---

**参考資料：**
- [XRPL Escrow Documentation](https://xrpl.org/escrow.html)
- [xrpl.js リファレンス](https://js.xrpl.org/)
